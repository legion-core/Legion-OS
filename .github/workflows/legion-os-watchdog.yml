name: Legion-OS Watchdog

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  watchdog:
    runs-on: ubuntu-latest

    steps:
      - name: Legion-OS Build Health Monitor
        id: check
        run: |
          set -euo pipefail

          echo ""
          echo "================================================="
          echo " Legion-OS Build Health Monitor Starting"
          echo "================================================="
          echo "Target workflow: legion-os-scheduled-builder.yml"
          echo ""

          API_URL="https://api.github.com/repos/${{ github.repository }}/actions/workflows/legion-os-scheduled-builder.yml/runs?per_page=30"

          echo "[INFO] Contacting GitHub API..."
          RESPONSE=$(curl -fsSL \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            "$API_URL") || {
              echo "[ERROR] GitHub API unreachable."
              echo "[SAFEGUARD] Skipping rebuild to avoid false trigger."
              echo "stale=false" >> $GITHUB_OUTPUT
              exit 0
          }

          echo "[OK] API reachable."

          TOTAL_RUNS=$(echo "$RESPONSE" | jq '.workflow_runs | length')
          echo "[INFO] Total workflow runs received: $TOTAL_RUNS"

          RUNS=$(echo "$RESPONSE" | jq '
            .workflow_runs
            | map(select(.status=="completed"))
            | map(select(.head_branch=="main"))
            | .[0:10]
          ')

          COUNT=$(echo "$RUNS" | jq 'length')
          echo "[INFO] Completed runs on main selected: $COUNT"

          if [ "$COUNT" -lt 5 ]; then
            echo "[WARN] Not enough data for reliable analysis."
            echo "[SAFEGUARD] Skipping rebuild."
            echo "stale=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo ""
          echo "--------------- Analyzed Runs ---------------"
          echo "$RUNS" | jq -r '
            .[]
            | "Run ID: \(.id) | Conclusion: \(.conclusion) | Updated: \(.updated_at)"
          '
          echo "--------------------------------------------"

          FAIL_STREAK=0
          INDEX=1

          echo ""
          echo "[INFO] Calculating consecutive failure streak..."

          for RESULT in $(echo "$RUNS" | jq -r '.[].conclusion'); do
            echo "  Run $INDEX => $RESULT"

            if [ "$RESULT" = "success" ]; then
              echo "  Encountered SUCCESS → stopping streak count."
              break
            elif [ "$RESULT" = "failure" ]; then
              FAIL_STREAK=$((FAIL_STREAK+1))
            else
              echo "  Non-standard conclusion ($RESULT) → stopping."
              break
            fi

            INDEX=$((INDEX+1))
          done

          echo ""
          echo "[RESULT] Consecutive failures detected: $FAIL_STREAK"

          if [ "$FAIL_STREAK" -ge 5 ]; then
            echo "[DECISION] System UNHEALTHY"
            echo "[ACTION] Rebuild will be triggered."
            echo "stale=true" >> $GITHUB_OUTPUT
          else
            echo "[DECISION] System HEALTHY"
            echo "[ACTION] No rebuild required."
            echo "stale=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger rebuild if unhealthy
        if: steps.check.outputs.stale == 'true'
        run: |
          echo ""
          echo "================================================="
          echo " Triggering Legion-OS Scheduled Builder"
          echo "================================================="

          curl -fsSL -X POST \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/legion-os-scheduled-builder.yml/dispatches \
            -d '{"ref":"main"}'

          echo "[OK] Rebuild dispatch sent."

      - name: System healthy
        if: steps.check.outputs.stale == 'false'
        run: |
          echo ""
          echo "================================================="
          echo " Legion-OS Pipeline Healthy"
          echo "================================================="
